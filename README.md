# 📚 PyRefPmid: Markdown PubMed Referencer (v1.3.0)

**PyRefPmid** は、Markdown 原稿内の PubMed ID (PMID) を自動検出し、PubMed API から書誌情報を取得して参考文献リスト (References) を自動生成する Python スクリプトです。

かつて研究者に愛用されていたツール「QRef」の利便性を、現代の Markdown 執筆環境において再現・簡略化することを目指して開発されました。論文執筆において、論文原稿用 Markdown ファイル内に PMID タグを埋め込むだけで引用番号の付与と文献リストの作成を一括で行うことができます。

## ✨ 主な機能

- 📂 **スマートファイル選択**: フォルダ内の Markdown ファイルを自動検出します。複数ある場合はメニューから選択でき、GUI ダイアログも利用可能です。
- 🔄 **PMID 抽出 & 引用置換**: `[pm 12345678]()` 形式の記述を検出し、`(1)` などの引用番号に自動置換します。
- 📡 **書誌情報取得 & キャッシュ**: PubMed API から論文情報を取得し、`paper.json` としてローカルにキャッシュすることで高速化を実現しています。
- 📋 **参考文献リスト生成 (Clean Regeneration)**: `References` セクションを自動生成・更新します。再生成時は常にクリーンアップされるため、古い情報が残ることはありません。
- 🎨 **高度なフォーマット設定**: 著者名の表記（`Fujita M` vs `Fujita, M.`）や引用形式を柔軟にカスタマイズ可能です。

## 📦 必要なもの

- Python 3.7+
- `requests` ライブラリ (`pip install requests`)

## 🚀 使用方法

本スクリプトは単一のファイルで動作します。インストール不要で、任意のディレクトリにコピーして使用できます。

### 🏁 基本的な実行

```bash
python PyRefPmid.py
```

- **ファイルが1つだけ**の場合: 自動的に処理が開始されます。
- **複数ある場合**: 対話メニューまたは GUI でファイルを選択します。

処理が完了すると、元のファイル名に `_cited` が付いたファイル（例: `draft_cited.md`）が生成されます。

### ✍️ 原稿内での記述方法

Markdown 内で以下のように PMID を記述します（大文字小文字区別なし、`[pmid 12345678]` 形式も可）。

- **リンク形式**: `[pm 12345678]()` （URL 部分 `()` は無視されます）
- **タグ形式**: `[pm 12345678]`

```markdown
この研究は重要です [pm 12345678]()。
タグ形式 [pm 87654321] も使用できます。
```

実行後:
```markdown
この研究は重要です (1)。
タグ形式 (2) も使用できます。

... (末尾)
# References

1. Authors... Title... (12345678)
2. Authors... Title... (87654321)
```

### ⚙️ コマンドラインオプション

引数を指定することで、動作を詳細にカスタマイズできます。

```bash
python PyRefPmid.py [入力ファイル] [オプション]
```

#### 🛠️ 基本オプション
- **`input_file`** (位置引数)
  - 処理対象の Markdown ファイルパス。
  - **デフォルト**: 省略時は実行ディレクトリ内で `.md` ファイルを自動検索します。
- **`-o`, `--output-file`**
  - 処理結果の保存先パス。
  - **デフォルト**: `[入力ファイル名]_cited.md`
- **`--no-cache`**
  - キャッシュ機能を使用せず、常に API から最新情報を取得します。

#### 🎨 フォーマット設定
- **`--author-name-format`**
  - 著者名の表示形式。
  - **デフォルト**: `{name}` (PubMed API の生データ: 例 `Smith J`)
  - **プレースホルダー**: `{last}` (姓), `{initials}` (イニシャル), `{name}` (姓名)
  - **例**: `"{last}, {initials}."` -> `Smith, J.`
- **`--citation-format`**
  - 本文中の引用ラベルの形式。
  - **デフォルト**: `({number})`
  - **例**: `[{number}]` -> `[1]`
- **`--ref-item-format`**
  - 参考文献リストの各項目の表示テンプレート。
  - **デフォルト**: `{number}. {authors}. {title} {journal} {year};{volume}:{pages}. doi: {doi}. [{pmid}](...)`
  - **プレースホルダー**: `{number}`, `{authors}`, `{title}`, `{journal}`, `{year}`, `{volume}`, `{issue}`, `{pages}`, `{doi}`, `{pmid}`
- **`--author-threshold`**
  - 参考文献リストに表示する著者の最大数。この数を超えると `et al` で省略されます。
  - **デフォルト**: `0` (全員表示)
- **`--references-header`**
  - 参考文献セクションの見出し。
  - **デフォルト**: `References`

#### 🔧 高度な設定
- **`--api-key`**
  - PubMed (NCBI) の API キー。指定するとリクエスト制限が緩和され、処理が高速化します。
- **`--api-delay`**
  - API リクエスト間の待機時間（秒）。
  - **デフォルト**: `0.4` (APIキー指定時は自動で `0.1` に短縮されます)
- **`--pmid-regex`**
  - PMID を抽出するための正規表現パターン。
- **`--cache-file`**
  - キャッシュファイルの保存パス。
  - **デフォルト**: `[入力ファイル名].json`

## 🧑‍💻 作者 (Author)

- **mfujita47 (Mitsugu Fujita)** - [GitHub](https://github.com/mfujita47)

## 📄 ライセンス

[MIT License](LICENSE)

## 📜 変更履歴

詳細は [CHANGELOG.md](CHANGELOG.md) を参照してください。
